<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>팀 순위 - 중고등 배구 데이터</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <a href="index.html" style="text-decoration: none; color: white; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-volleyball-ball"></i>
                    <span>배구 연맹 데이터</span>
                </a>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link hide-on-mobile">홈</a>
                <a href="team_ranking.html" class="nav-link active">팀 순위</a>
                <a href="player_record.html" class="nav-link">선수 기록</a>
                <a href="match_results.html" class="nav-link">경기 결과</a>
                <a href="player_certification.html" class="nav-link hide-on-mobile" target="_blank">기록 증명서</a>
                <a href="admin.html" class="nav-link admin-only-nav" style="display:none;">관리자</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-trophy"></i> 팀 순위</h1>
            <p>시즌, 라운드, 성별로 필터링하여 학교(팀) 순위를 확인하세요.</p>
        </div>

        <!-- 검색 및 필터 -->
        <div class="search-section">
            <div class="search-controls">
                <div class="filter-group">                    
                    <select id="seasonFilter">
                        <option value="">시즌 선택</option>
                        <!-- 동적으로 생성 -->
                    </select>
                    <select id="roundFilter">
                        <option value="">라운드 선택</option>
                        <!-- 동적으로 생성 -->
                    </select>
                    <select id="genderFilter">
                        <option value="">성별 선택</option>
                        <!-- 동적으로 생성 -->
                    </select>
                    <select id="schoolLevelFilter">
                        <option value="">중고등 선택</option>
                        <!-- 동적으로 생성 -->
                    </select>
                    <button class="btn btn-outline" id="resetFilters">
                        <i class="fas fa-undo"></i> 초기화
                    </button>
                    <button class="btn btn-secondary" id="searchButton">
                        <i class="fas fa-search"></i> 검색하기
                    </button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-wrapper">
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>순위</th>
                            <th>학교</th>
                            <th>경기 수</th>
                            <th>승</th>
                            <th>패</th>
                            <th class="hide-on-mobile">세트 승</th>
                            <th class="hide-on-mobile">세트 패</th>
                        </tr>
                    </thead>
                    <tbody id="team-ranking-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p>© 2025 Korea University Volleyball Federation (KUVF). All rights reserved.</p>
            <p>Developer Contact: kuvf.dev@gmail.com (문의)</p>
        </div>
    </footer>

        <script src="data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            populateFilters();
            
            // 초기에는 결과를 숨김
            document.getElementById('team-ranking-body').innerHTML = '<tr><td colspan="7" style="text-align:center;">검색 후 결과를 확인하세요.</td></tr>';
            
            // 검색 버튼 이벤트 리스너
            document.getElementById('searchButton').addEventListener('click', renderRankings);
            
            // 초기화 버튼
            document.getElementById('resetFilters').addEventListener('click', () => {
                document.getElementById('seasonFilter').value = '';
                document.getElementById('roundFilter').value = '';
                document.getElementById('genderFilter').value = '';
                document.getElementById('schoolLevelFilter').value = '';
                document.getElementById('team-ranking-body').innerHTML = '<tr><td colspan="7" style="text-align:center;">검색 후 결과를 확인하세요.</td></tr>';
            });
        });

        function populateFilters() {
            const seasons = [...new Set(tournaments.map(t => t.season))];
            const rounds = [...new Set(tournaments.map(t => t.round))];
            const genders = [...new Set(tournaments.map(t => t.gender))];

            const seasonFilter = document.getElementById('seasonFilter');
            seasons.sort((a, b) => b - a).forEach(season => {
                seasonFilter.add(new Option(`${season}년`, season));
            });

            const roundFilter = document.getElementById('roundFilter');
            rounds.forEach(round => {
                roundFilter.add(new Option(round, round));
            });

            const genderFilter = document.getElementById('genderFilter');
            genders.forEach(gender => {
                genderFilter.add(new Option(gender === 'male' ? '남자' : '여자', gender));
            });
        }

        function renderRankings() {
            const season = document.getElementById('seasonFilter').value;
            const round = document.getElementById('roundFilter').value;
            const gender = document.getElementById('genderFilter').value;
            const schoolLevel = document.getElementById('schoolLevelFilter').value;

            const filteredTournaments = tournaments.filter(t => 
                (!season || t.season == season) &&
                (!round || t.round === round) &&
                (!gender || t.gender === gender) &&
                (!schoolLevel || t.school_level === schoolLevel)
            );
            const tournamentIds = filteredTournaments.map(t => t.id);

            const filteredMatches = matches.filter(m => tournamentIds.includes(m.tournaments_id) && m.status === '종료');

            const teamStats = {};
            teams.forEach(team => {
                if (!schoolLevel || team.school_level === schoolLevel) {
                    teamStats[team.id] = {
                        id: team.id,
                        name: team.name,
                        matchesPlayed: 0,
                        wins: 0,
                        losses: 0,
                        setsWon: 0,
                        setsLost: 0,
                        pointsFor: 0,
                        pointsAgainst: 0
                    };
                }
            });

            filteredMatches.forEach(match => {
                if (!teamStats[match.home_team_id] || !teamStats[match.away_team_id]) return;

                teamStats[match.home_team_id].matchesPlayed++;
                teamStats[match.away_team_id].matchesPlayed++;

                if (match.home_sets_won > match.away_sets_won) {
                    teamStats[match.home_team_id].wins++;
                    teamStats[match.away_team_id].losses++;
                } else {
                    teamStats[match.home_team_id].losses++;
                    teamStats[match.away_team_id].wins++;
                }

                teamStats[match.home_team_id].setsWon += match.home_sets_won;
                teamStats[match.home_team_id].setsLost += match.away_sets_won;
                teamStats[match.away_team_id].setsWon += match.away_sets_won;
                teamStats[match.away_team_id].setsLost += match.home_sets_won;

                const matchSets = set_scores.filter(s => s.match_id === match.id);
                matchSets.forEach(set => {
                    teamStats[match.home_team_id].pointsFor += set.home_team_score;
                    teamStats[match.home_team_id].pointsAgainst += set.away_team_score;
                    teamStats[match.away_team_id].pointsFor += set.away_team_score;
                    teamStats[match.away_team_id].pointsAgainst += set.home_team_score;
                });
            });

            const rankedTeams = Object.values(teamStats)
                .filter(team => team.matchesPlayed > 0)
                .sort((a, b) => {
                    if (b.wins !== a.wins) return b.wins - a.wins; // 1. 승수
                    const setRatioA = a.setsLost === 0 ? a.setsWon : a.setsWon / a.setsLost;
                    const setRatioB = b.setsLost === 0 ? b.setsWon : b.setsWon / b.setsLost;
                    if (setRatioB !== setRatioA) return setRatioB - setRatioA; // 2. 세트 득실률
                    const pointsRatioA = a.pointsAgainst === 0 ? a.pointsFor : a.pointsFor / a.pointsAgainst;
                    const pointsRatioB = b.pointsAgainst === 0 ? b.pointsFor : b.pointsFor / b.pointsAgainst;
                    return pointsRatioB - pointsRatioA; // 3. 점수 득실률
                });

            const tbody = document.getElementById('team-ranking-body');
            if (rankedTeams.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">조건에 맞는 순위 정보가 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = rankedTeams.map((team, index) => `
                <tr>
                    <td class="rank">${index + 1}</td>
                    <td class="team-name">${team.name}</td>
                    <td>${team.matchesPlayed}</td>
                    <td>${team.wins}</td>
                    <td>${team.losses}</td>
                    <td class="hide-on-mobile">${team.setsWon}</td>
                    <td class="hide-on-mobile">${team.setsLost}</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
