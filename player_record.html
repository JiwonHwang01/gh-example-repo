<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>선수 개인 기록 - 중고등 배구 데이터</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <a href="index.html" style="text-decoration: none; color: white; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-volleyball-ball"></i>
                    <span>배구 연맹 데이터</span>
                </a>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link hide-on-mobile">홈</a>
                <a href="team_ranking.html" class="nav-link">팀 순위</a>
                <a href="player_record.html" class="nav-link active">선수 기록</a>
                <a href="match_results.html" class="nav-link">경기 결과</a>
                <a href="player_certification.html" class="nav-link hide-on-mobile" target="_blank">기록 증명서</a>
                <a href="admin.html" class="nav-link admin-only-nav" style="display:none;">관리자</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- 페이지 헤더 -->
        <div class="page-header">
            <h1><i class="fas fa-user-friends"></i> 선수 개인 기록</h1>
            <p>전국 중고등학교 배구 선수들의 상세 기록을 확인하세요</p>
        </div>

        <!-- 탭 컨테이너 -->
        <div class="tab-container">
            <div class="tab-header">
                <button class="tab-button active" onclick="switchTab('male')">남자부</button>
                <button class="tab-button" onclick="switchTab('female')">여자부</button>
            </div>
            <div class="tab-content">
                <!-- 검색 및 필터 -->
                <div class="search-section">
                    <div class="search-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="playerSearch" placeholder="선수 이름으로 검색">
                        </div>
                        <div class="filter-group">
                            <select id="seasonFilter">
                                <option value="">시즌 선택</option>
                            </select>
                            <select id="roundFilter">
                                <option value="">라운드 선택</option>
                            </select>
                            <select id="sortFilter">
                                <option value="points">득점</option>
                                <option value="attack">공격</option>
                                <option value="blocks">블로킹</option>
                                <option value="serves">서브</option>
                                <option value="games">경기수</option>
                            </select>
                            <button class="btn btn-outline" id="resetFilters">
                                <i class="fas fa-undo"></i> 초기화
                            </button>
                            <button class="btn btn-secondary" id="searchButton">
                                <i class="fas fa-search"></i> 검색하기
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 통계 요약 -->
                <div class="stats-summary hide-on-mobile">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number" id="totalPlayers">0</div>
                            <div class="stat-label">총 선수 수</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number" id="filteredPlayers">0</div>
                            <div class="stat-label">검색 결과</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number">156</div>
                            <div class="stat-label">MVP 선수</div>
                        </div>
                    </div>
                </div>

                <!-- 선수 기록 테이블 -->
                <div class="table-container">
                    <div class="table-header">
                        <h2>선수 기록</h2>
                        <div class="table-actions hide-on-mobile">
                            <button class="btn btn-outline" onclick="exportData()">
                                <i class="fas fa-download"></i> 엑셀 다운로드
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                        <table class="players-table" id="playersTable">
                            <thead>
                                <tr>
                                    <th>순서</th>
                                    <th>
                                        선수</i>
                                    </th>
                                    <th class="hide-on-mobile">
                                        포지션
                                    </th>
                                    <th class="hide-on-mobile">
                                        전체팀</i>
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(4)">
                                        경기수
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(5)">
                                        세트수 <i class="fas fa-chevron-down"></i>
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(6)">
                                        공격 <i class="fas fa-chevron-down"></i>
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(7)">
                                        블로킹 <i class="fas fa-chevron-down"></i>
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(8)">
                                        서브 <i class="fas fa-chevron-down"></i>
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(9)">
                                        득점 <i class="fas fa-chevron-down"></i>
                                    </th>
                                    <th>상세</th>
                                </tr>
                            </thead>
                            <tbody id="playersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 페이지네이션 -->
                <div class="pagination">
                    <button class="page-btn" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></button>
                    <div class="page-numbers" id="pageNumbers"></div>
                    <button class="page-btn" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- 선수 상세 모달 -->
    <div id="playerModal" class="modal">
        <div class="modal-content large">
            <span class="close">&times;</span>
            <div class="player-detail">
                <div class="player-header">
                    <div class="player-photo">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="player-info">
                        <h2 id="modalPlayerName"></h2>
                        <p id="modalPlayerSchool"></p>
                        <p id="modalPlayerPosition"></p>
                    </div>
                </div>
                
                <div class="player-stats">
                    <div class="stats-tabs">
                        <div class="tab-buttons">
                            <button class="stats-tab-btn active" onclick="switchStatsTab('overview')">개요</button>
                            <button class="stats-tab-btn" onclick="switchStatsTab('attack')">공격</button>
                            <button class="stats-tab-btn" onclick="switchStatsTab('block')">블로킹</button>
                            <button class="stats-tab-btn" onclick="switchStatsTab('receive')">리시브</button>
                            <button class="stats-tab-btn" onclick="switchStatsTab('serve')">서브</button>
                            <button class="stats-tab-btn" onclick="switchStatsTab('dig')">디그</button>
                            <button class="stats-tab-btn" onclick="switchStatsTab('set')">세트</button>
                        </div>
                        <div class="stats-content">
                            <div id="overview-tab" class="stats-tab active">
                                <div class="stats-grid" id="overviewStatsGrid">
                                    <!-- Overview stats will be populated here -->
                                </div>
                            </div>
                            <div id="attack-tab" class="stats-tab">
                                <div class="stats-grid" id="attackStatsGrid">
                                    <!-- Attack stats will be populated here -->
                                </div>
                            </div>
                            <div id="block-tab" class="stats-tab">
                                <div class="stats-grid" id="blockStatsGrid">
                                    <!-- Block stats will be populated here -->
                                </div>
                            </div>
                            <div id="receive-tab" class="stats-tab">
                                <div class="stats-grid" id="receiveStatsGrid">
                                    <!-- Receive stats will be populated here -->
                                </div>
                            </div>
                            <div id="serve-tab" class="stats-tab">
                                <div class="stats-grid" id="serveStatsGrid">
                                    <!-- Serve stats will be populated here -->
                                </div>
                            </div>
                            <div id="dig-tab" class="stats-tab">
                                <div class="stats-grid" id="digStatsGrid">
                                    <!-- Dig stats will be populated here -->
                                </div>
                            </div>
                            <div id="set-tab" class="stats-tab">
                                <div class="stats-grid" id="setStatsGrid">
                                    <!-- Set stats will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="recent-games">
                    <h3>최근 경기 기록</h3>
                    <div class="games-list" id="recentGames">
                        <!-- 최근 경기 기록 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p>© 2025 Korea University Volleyball Federation (KUVF). All rights reserved.</p>
            <p>Developer Contact: kuvf.dev@gmail.com (문의)</p>
        </div>
    </footer>

    <script src="data.js"></script>
    <script>
        let currentGender = 'male';
        let processedPlayersData = [];
        let filteredData = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentSort = { column: 9, direction: 'desc' }; // 기본값: 득점 내림차순

        document.addEventListener('DOMContentLoaded', function() {
            processData();
            populateFilters();
            setupEventListeners();
            // 초기에는 결과를 숨김
            document.getElementById('playersTableBody').innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 2rem 1rem;">검색 후 결과를 확인하세요.</td></tr>';
        });

        function switchTab(gender) {
            currentGender = gender;
            
            // 탭 버튼 스타일 변경
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 데이터 필터링 및 렌더링
            filterAndRender();
        }

        function processData() {
            processedPlayersData = players.map(player => {
                const playerStats = player_match_stats.filter(s => s.player_id === player.id);
                const games = [...new Set(playerStats.map(s => s.match_id))];
                
                let totalStats = {
                    points: 0, 
                    attack_attempts: 0, 
                    attack_successes: 0, 
                    block_successes: 0,
                    serve_aces: 0,
                    sets_played: 0
                };

                playerStats.forEach(stat => {
                    totalStats.points += stat.points;
                    totalStats.attack_attempts += stat.attack_attempts;
                    totalStats.attack_successes += stat.attack_successes;
                    totalStats.block_successes += stat.block_successes;
                    totalStats.serve_aces += stat.serve_aces;
                    totalStats.sets_played += (stat.played_set1 ? 1 : 0) + 
                                            (stat.played_set2 ? 1 : 0) + 
                                            (stat.played_set3 ? 1 : 0) + 
                                            (stat.played_set4 ? 1 : 0) + 
                                            (stat.played_set5 ? 1 : 0);
                });

                return {
                    ...player,
                    team: teams.find(t => t.id === player.team_id),
                    games: games.length,
                    sets: totalStats.sets_played,
                    points: totalStats.points,
                    attack: totalStats.attack_successes,
                    blocks: totalStats.block_successes,
                    serves: totalStats.serve_aces
                };
            });
        }

        function populateFilters() {
            // 시즌 필터 채우기
            const seasons = [...new Set(tournaments.map(t => t.season))];
            const seasonFilter = document.getElementById('seasonFilter');
            seasonFilter.innerHTML = '<option value="">시즌 선택</option>';
            seasons.sort((a, b) => b - a).forEach(s => {
                seasonFilter.innerHTML += `<option value="${s}">${s}년</option>`;
            });

            // 라운드 필터 채우기
            const rounds = [...new Set(tournaments.map(t => t.round))];
            const roundFilter = document.getElementById('roundFilter');
            roundFilter.innerHTML = '<option value="">라운드 선택</option>';
            rounds.sort().forEach(r => {
                roundFilter.innerHTML += `<option value="${r}">${r}</option>`;
            });
        }

        function setupEventListeners() {
            // 검색 버튼 이벤트 리스너
            document.getElementById('searchButton').addEventListener('click', filterAndRender);
            
            // 엔터키로 검색 가능하도록
            document.getElementById('playerSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterAndRender();
                }
            });
            
            // 초기화 버튼
            document.getElementById('resetFilters').addEventListener('click', () => {
                document.querySelectorAll('#playerSearch, #seasonFilter, #roundFilter, #sortFilter').forEach(el => el.value = '');
                document.getElementById('playersTableBody').innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 2rem 1rem;">검색 후 결과를 확인하세요.</td></tr>';
                document.getElementById('filteredPlayers').textContent = '0';
            });
            
            // 모달 닫기 버튼 이벤트 리스너
            document.querySelector('.close').addEventListener('click', function() {
                document.getElementById('playerModal').style.display = 'none';
            });
            
            // 모달 외부 클릭시 닫기
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('playerModal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // ESC 키로 모달 닫기
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modal = document.getElementById('playerModal');
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                }
            });
        }

        function filterAndRender() {
            const searchTerm = document.getElementById('playerSearch').value.toLowerCase();
            const season = document.getElementById('seasonFilter').value;
            const round = document.getElementById('roundFilter').value;
            const sortBy = document.getElementById('sortFilter').value;

            // 성별 필터링
            let filteredTournaments = tournaments.filter(t => t.gender === currentGender);
            
            // 시즌/라운드 필터링
            if (season) {
                filteredTournaments = filteredTournaments.filter(t => t.season == season);
            }
            if (round) {
                filteredTournaments = filteredTournaments.filter(t => t.round === round);
            }

            // 해당 토너먼트의 매치 ID들
            const relevantMatchIds = new Set(
                matches.filter(m => filteredTournaments.some(t => t.id === m.tournaments_id))
                       .map(m => m.id)
            );

            // 선수 데이터 필터링 - 필터가 없으면 모든 데이터 표시
            if (!season && !round && !searchTerm) {
                filteredData = processedPlayersData.filter(player => player.games > 0);
            } else {
                filteredData = processedPlayersData.filter(player => {
                    const hasStatsInFilter = player_match_stats.some(s => 
                        s.player_id === player.id && relevantMatchIds.has(s.match_id)
                    );
                    const matchesSearch = player.name.toLowerCase().includes(searchTerm);
                    return hasStatsInFilter && player.games > 0 && matchesSearch;
                });
            }

            // 정렬 기준 설정
            const sortMap = {
                'points': 9,
                'attack': 6,
                'blocks': 7,
                'serves': 8,
                'games': 4
            };
            currentSort.column = sortMap[sortBy] || 9;
            currentSort.direction = 'desc';

            currentPage = 1;
            sortAndRender();
        }

        function sortTable(columnIndex) {
            if (currentSort.column === columnIndex) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = columnIndex;
                currentSort.direction = 'asc';
            }
            sortAndRender();
        }

        function sortAndRender() {
            const { column, direction } = currentSort;
            
            filteredData.sort((a, b) => {
                let valA, valB;
                
                switch(column) {
                    case 1: // 선수명
                        valA = a.name.toLowerCase();
                        valB = b.name.toLowerCase();
                        break;
                    case 2: // 포지션
                        valA = a.position;
                        valB = b.position;
                        break;
                    case 3: // 팀명
                        valA = a.team.name.toLowerCase();
                        valB = b.team.name.toLowerCase();
                        break;
                    case 4: // 경기수
                        valA = a.games;
                        valB = b.games;
                        break;
                    case 5: // 세트수
                        valA = a.sets;
                        valB = b.sets;
                        break;
                    case 6: // 공격
                        valA = a.attack;
                        valB = b.attack;
                        break;
                    case 7: // 블로킹
                        valA = a.blocks;
                        valB = b.blocks;
                        break;
                    case 8: // 서브
                        valA = a.serves;
                        valB = b.serves;
                        break;
                    case 9: // 득점
                        valA = a.points;
                        valB = b.points;
                        break;
                    default:
                        valA = a.points;
                        valB = b.points;
                }

                if (typeof valA === 'string') {
                    return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    return direction === 'asc' ? valA - valB : valB - valA;
                }
            });

            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('playersTableBody');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            document.getElementById('filteredPlayers').textContent = filteredData.length.toLocaleString();
            document.getElementById('totalPlayers').textContent = players.length.toLocaleString();

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center;">데이터가 없습니다.</td></tr>';
            } else {
                tbody.innerHTML = pageData.map((player, index) => {
                    const positionClass = getPositionClass(player.position);
                    return `
                        <tr>
                            <td class="rank">${start + index + 1}</td>
                            <td class="player-name">${player.name}</td>
                            <td class="hide-on-mobile"><span class="position ${positionClass}">${getPositionText(player.position)}</span></td>
                            <td class="hide-on-mobile">${player.team.name}</td>
                            <td class="hide-on-mobile">${player.games}</td>
                            <td class="hide-on-mobile">${player.sets}</td>
                            <td class="hide-on-mobile">${player.attack}</td>
                            <td class="hide-on-mobile">${player.blocks}</td>
                            <td class="hide-on-mobile">${player.serves}</td>
                            <td class="hide-on-mobile"><strong>${player.points}</strong></td>
                            <td><button class="view-btn" onclick='showPlayerDetail(${player.id})'>상세</button></td>
                        </tr>
                    `;
                }).join('');
            }
            renderPagination();
        }

        function changePage(offset) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const newPage = currentPage + offset;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        function renderPagination() {
            const pageNumbers = document.getElementById('pageNumbers');
            if (!pageNumbers) return;
            
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            pageNumbers.innerHTML = '';

            const prevButton = document.querySelector('.pagination .page-btn:first-child');
            const nextButton = document.querySelector('.pagination .page-btn:last-child');
            if(prevButton) prevButton.disabled = currentPage === 1;
            if(nextButton) nextButton.disabled = currentPage === totalPages || totalPages === 0;

            for (let i = 1; i <= totalPages; i++) {
                if (totalPages > 1) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => {
                        currentPage = i;
                        renderTable();
                    };
                    pageNumbers.appendChild(pageBtn);
                }
            }
        }

        function showPlayerDetail(playerId) {
            const player = processedPlayersData.find(p => p.id === playerId);
            const playerStats = player_match_stats.filter(s => s.player_id === playerId);

            document.getElementById('modalPlayerName').textContent = player.name;
            document.getElementById('modalPlayerSchool').textContent = player.team.name;
            document.getElementById('modalPlayerPosition').textContent = getPositionName(player.position);
            
            // 통계 데이터 집계
            const aggregatedStats = playerStats.reduce((acc, stat) => {
                acc.points += stat.points;
                acc.games = (acc.games || new Set()).add(stat.match_id);
                Object.keys(stat).forEach(key => {
                    if (key.includes('_')) { // is a stat like attack_attempts
                        acc[key] = (acc[key] || 0) + stat[key];
                    }
                });
                return acc;
            }, { points: 0 });

            // 성공률 계산
            const attackSuccessRate = aggregatedStats.attack_attempts > 0 ? 
                (aggregatedStats.attack_successes / aggregatedStats.attack_attempts * 100).toFixed(1) : '0.0';
            const blockSuccessRate = aggregatedStats.block_attempts > 0 ? 
                (aggregatedStats.block_successes / aggregatedStats.block_attempts * 100).toFixed(1) : '0.0';
            const receiveSuccessRate = aggregatedStats.receive_attempts > 0 ? 
                (aggregatedStats.receive_successes / aggregatedStats.receive_attempts * 100).toFixed(1) : '0.0';
            const serveSuccessRate = aggregatedStats.serve_attempts > 0 ? 
                (aggregatedStats.serve_aces / aggregatedStats.serve_attempts * 100).toFixed(1) : '0.0';
            const digSuccessRate = aggregatedStats.dig_attempts > 0 ? 
                (aggregatedStats.dig_successes / aggregatedStats.dig_attempts * 100).toFixed(1) : '0.0';
            const setSuccessRate = aggregatedStats.set_attempts > 0 ? 
                (aggregatedStats.set_successes / aggregatedStats.set_attempts * 100).toFixed(1) : '0.0';

            // 개요 탭 (핵심 지표)
            const overviewGrid = document.getElementById('overviewStatsGrid');
            overviewGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-title">총 득점</div>
                    <div class="stat-value">${aggregatedStats.points}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">경기 수</div>
                    <div class="stat-value">${aggregatedStats.games.size}</div>
                </div>
                
            `;

            // 공격 탭
            const attackGrid = document.getElementById('attackStatsGrid');
            const attackFails = aggregatedStats.attack_attempts - aggregatedStats.attack_successes;
            attackGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-title">시도</div>
                    <div class="stat-value">${aggregatedStats.attack_attempts}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">성공</div>
                    <div class="stat-value">${aggregatedStats.attack_successes}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">실패</div>
                    <div class="stat-value">${attackFails}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">성공률</div>
                    <div class="stat-value">${attackSuccessRate}%</div>
                </div>
            `;

            // 블로킹 탭
            const blockGrid = document.getElementById('blockStatsGrid');
            const blockFails = aggregatedStats.block_attempts - aggregatedStats.block_successes;
            blockGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-title">시도</div>
                    <div class="stat-value">${aggregatedStats.block_attempts}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">성공</div>
                    <div class="stat-value">${aggregatedStats.block_successes}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">실패</div>
                    <div class="stat-value">${blockFails}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">성공률</div>
                    <div class="stat-value">${blockSuccessRate}%</div>
                </div>
            `;

            // 리시브 탭
            const receiveGrid = document.getElementById('receiveStatsGrid');
            const receiveFails = aggregatedStats.receive_attempts - aggregatedStats.receive_successes;
            receiveGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-title">시도</div>
                    <div class="stat-value">${aggregatedStats.receive_attempts}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">성공</div>
                    <div class="stat-value">${aggregatedStats.receive_successes}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">실패</div>
                    <div class="stat-value">${receiveFails}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">성공률</div>
                    <div class="stat-value">${receiveSuccessRate}%</div>
                </div>
            `;

            // 서브 탭
            const serveGrid = document.getElementById('serveStatsGrid');
            const serveFails = aggregatedStats.serve_attempts - aggregatedStats.serve_aces;
            serveGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-title">시도</div>
                    <div class="stat-value">${aggregatedStats.serve_attempts}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">성공</div>
                    <div class="stat-value">${aggregatedStats.serve_aces}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">실패</div>
                    <div class="stat-value">${serveFails}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">성공률</div>
                    <div class="stat-value">${serveSuccessRate}%</div>
                </div>
            `;

            // 디그 탭
            const digGrid = document.getElementById('digStatsGrid');
            const digFails = aggregatedStats.dig_attempts - aggregatedStats.dig_successes;
            digGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-title">시도</div>
                    <div class="stat-value">${aggregatedStats.dig_attempts}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">성공</div>
                    <div class="stat-value">${aggregatedStats.dig_successes}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">실패</div>
                    <div class="stat-value">${digFails}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">성공률</div>
                    <div class="stat-value">${digSuccessRate}%</div>
                </div>
            `;

            // 세트 탭
            const setGrid = document.getElementById('setStatsGrid');
            const setFails = aggregatedStats.set_attempts - aggregatedStats.set_successes;
            setGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-title">시도</div>
                    <div class="stat-value">${aggregatedStats.set_attempts}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">성공</div>
                    <div class="stat-value">${aggregatedStats.set_successes}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">실패</div>
                    <div class="stat-value">${setFails}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-title">성공률</div>
                    <div class="stat-value">${setSuccessRate}%</div>
                </div>
            `;

            const recentGamesContainer = document.getElementById('recentGames');
            // 최근 5경기만 표시하고 상대팀명과 승패만 표시
            const recentGames = playerStats
                .sort((a, b) => {
                    const matchA = matches.find(m => m.id === a.match_id);
                    const matchB = matches.find(m => m.id === b.match_id);
                    return new Date(matchB.date) - new Date(matchA.date);
                })
                .slice(0, 5);

            recentGamesContainer.innerHTML = recentGames.map(stat => {
                const match = matches.find(m => m.id === stat.match_id);
                const opponent = teams.find(t => t.id === (match.home_team_id === player.team_id ? match.away_team_id : match.home_team_id));
                
                // 승패 판정 (간단한 로직 - 실제로는 더 복잡할 수 있음)
                const isHome = match.home_team_id === player.team_id;
                const result = isHome ? 
                    (match.home_score > match.away_score ? '승' : '패') :
                    (match.away_score > match.home_score ? '승' : '패');
                
                return `<div class="game-item">vs. ${opponent.name} - ${result}</div>`;
            }).join('') || '<p>경기 기록이 없습니다.</p>';

            document.getElementById('playerModal').style.display = 'block';
        }

        function getPositionClass(position) {
            return position;
        }

        function getPositionText(position) {
            const positions = { 
                setter: "세터", 
                outside: "아웃사이드 히터", 
                middle: "미들 블로커", 
                opposite: "오포지트", 
                libero: "리베로" 
            };
            return positions[position] || position;
        }

        function getPositionName(position) {
            const positions = { setter: "세터", outside: "아웃사이드 히터", middle: "미들 블로커", opposite: "오포지트", libero: "리베로" };
            return positions[position] || position;
        }

        function switchStatsTab(tabName) {
            // 모든 탭 버튼에서 active 클래스 제거
            document.querySelectorAll('.stats-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 모든 탭 콘텐츠 숨기기
            document.querySelectorAll('.stats-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 클릭된 탭 버튼에 active 클래스 추가
            document.querySelector(`[onclick="switchStatsTab('${tabName}')"]`).classList.add('active');
            
            // 해당 탭 콘텐츠 보이기
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function exportData() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "이름,팀,포지션,경기수,세트수,공격,블로킹,서브,득점\n";
            filteredData.forEach(p => {
                csvContent += `${p.name},${p.team.name},${getPositionText(p.position)},${p.games},${p.sets},${p.attack},${p.blocks},${p.serves},${p.points}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "player_records.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>