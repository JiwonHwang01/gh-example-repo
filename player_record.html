<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>선수 개인 기록 - 중고등 배구 데이터</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-volleyball-ball"></i>
                <span>배구 연맹 데이터</span>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link">홈</a>
                <a href="team_ranking.html" class="nav-link">팀 순위</a>
                <a href="player_record.html" class="nav-link active">선수 기록</a>
                <a href="player_certification.html" class="nav-link hide-on-mobile" target="_blank">기록 증명서</a>
                <a href="admin.html" class="nav-link admin-only-nav" style="display:none;">관리자</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- 페이지 헤더 -->
        <div class="page-header">
            <h1><i class="fas fa-user-friends"></i> 선수 개인 기록</h1>
            <p>전국 중고등학교 배구 선수들의 상세 기록을 확인하세요</p>
        </div>

        <!-- 탭 컨테이너 -->
        <div class="tab-container">
            <div class="tab-header">
                <button class="tab-button active" onclick="switchTab('male')">남자부</button>
                <button class="tab-button" onclick="switchTab('female')">여자부</button>
            </div>
            <div class="tab-content">
                <!-- 검색 및 필터 -->
                <div class="search-section">
                    <div class="search-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="playerSearch" placeholder="선수 이름으로 검색">
                        </div>
                        <div class="filter-group">
                            <select id="seasonFilter">
                                <option value="">시즌 선택</option>
                            </select>
                            <select id="roundFilter">
                                <option value="">라운드 선택</option>
                            </select>
                            <select id="sortFilter">
                                <option value="points">득점</option>
                                <option value="attack">공격</option>
                                <option value="blocks">블로킹</option>
                                <option value="serves">서브</option>
                                <option value="games">경기수</option>
                            </select>
                            <button class="btn btn-outline" id="resetFilters">
                                <i class="fas fa-undo"></i> 초기화
                            </button>
                            <button class="btn btn-secondary" id="searchButton">
                                <i class="fas fa-search"></i> 검색하기
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 통계 요약 -->
                <div class="stats-summary hide-on-mobile">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number" id="totalPlayers">0</div>
                            <div class="stat-label">총 선수 수</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number" id="filteredPlayers">0</div>
                            <div class="stat-label">검색 결과</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number">156</div>
                            <div class="stat-label">MVP 선수</div>
                        </div>
                    </div>
                </div>

                <!-- 선수 기록 테이블 -->
                <div class="table-container">
                    <div class="table-header">
                        <h2>선수 기록</h2>
                        <div class="table-actions hide-on-mobile">
                            <button class="btn btn-outline" onclick="exportData()">
                                <i class="fas fa-download"></i> 엑셀 다운로드
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                        <table class="players-table" id="playersTable">
                            <thead>
                                <tr>
                                    <th>순서</th>
                                    <th onclick="sortTable(1)">
                                        선수 <i class="fas fa-chevron-down"></i>
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(2)">
                                        포지션
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(3)">
                                        전체팀 <i class="fas fa-chevron-down"></i>
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(4)">
                                        경기수
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(5)">
                                        세트수
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(6)">
                                        공격
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(7)">
                                        블로킹
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(8)">
                                        서브
                                    </th>
                                    <th class="hide-on-mobile" onclick="sortTable(9)">
                                        득점
                                    </th>
                                    <th>상세</th>
                                </tr>
                            </thead>
                            <tbody id="playersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 페이지네이션 -->
                <div class="pagination">
                    <button class="page-btn" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></button>
                    <div class="page-numbers" id="pageNumbers"></div>
                    <button class="page-btn" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- 선수 상세 모달 -->
    <div id="playerModal" class="modal">
        <div class="modal-content large">
            <span class="close">&times;</span>
            <div class="player-detail">
                <div class="player-header">
                    <div class="player-photo">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="player-info">
                        <h2 id="modalPlayerName"></h2>
                        <p id="modalPlayerSchool"></p>
                        <p id="modalPlayerPosition"></p>
                    </div>
                </div>
                
                <div class="player-stats">
                    <div class="stats-grid" id="modalStatsGrid">
                        <!-- Stats will be populated here -->
                    </div>
                </div>

                <div class="recent-games">
                    <h3>최근 경기 기록</h3>
                    <div class="games-list" id="recentGames">
                        <!-- 최근 경기 기록 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p>© 2025 Korea University Volleyball Federation (KUVF). All rights reserved.</p>
            <p>Developer Contact: kuvf.dev@gmail.com (문의)</p>
        </div>
    </footer>

    <script src="data.js"></script>
    <script>
        let currentGender = 'male';
        let processedPlayersData = [];
        let filteredData = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentSort = { column: 9, direction: 'desc' }; // 기본값: 득점 내림차순

        document.addEventListener('DOMContentLoaded', function() {
            processData();
            populateFilters();
            setupEventListeners();
            // 초기에는 결과를 숨김
            document.getElementById('playersTableBody').innerHTML = '<tr><td colspan="11" style="text-align: center;">검색 조건을 설정하고 검색하기 버튼을 눌러주세요.</td></tr>';
        });

        function switchTab(gender) {
            currentGender = gender;
            
            // 탭 버튼 스타일 변경
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 데이터 필터링 및 렌더링
            filterAndRender();
        }

        function processData() {
            processedPlayersData = players.map(player => {
                const playerStats = player_match_stats.filter(s => s.player_id === player.id);
                const games = [...new Set(playerStats.map(s => s.match_id))];
                
                let totalStats = {
                    points: 0, 
                    attack_attempts: 0, 
                    attack_successes: 0, 
                    block_successes: 0,
                    serve_aces: 0,
                    sets_played: 0
                };

                playerStats.forEach(stat => {
                    totalStats.points += stat.points;
                    totalStats.attack_attempts += stat.attack_attempts;
                    totalStats.attack_successes += stat.attack_successes;
                    totalStats.block_successes += stat.block_successes;
                    totalStats.serve_aces += stat.serve_aces;
                    totalStats.sets_played += (stat.played_set1 ? 1 : 0) + 
                                            (stat.played_set2 ? 1 : 0) + 
                                            (stat.played_set3 ? 1 : 0) + 
                                            (stat.played_set4 ? 1 : 0) + 
                                            (stat.played_set5 ? 1 : 0);
                });

                return {
                    ...player,
                    team: teams.find(t => t.id === player.team_id),
                    games: games.length,
                    sets: totalStats.sets_played,
                    points: totalStats.points,
                    attack: totalStats.attack_successes,
                    blocks: totalStats.block_successes,
                    serves: totalStats.serve_aces
                };
            });
        }

        function populateFilters() {
            // 시즌 필터 채우기
            const seasons = [...new Set(tournaments.map(t => t.season))];
            const seasonFilter = document.getElementById('seasonFilter');
            seasonFilter.innerHTML = '<option value="">시즌 선택</option>';
            seasons.sort((a, b) => b - a).forEach(s => {
                seasonFilter.innerHTML += `<option value="${s}">${s}년</option>`;
            });

            // 라운드 필터 채우기
            const rounds = [...new Set(tournaments.map(t => t.round))];
            const roundFilter = document.getElementById('roundFilter');
            roundFilter.innerHTML = '<option value="">라운드 선택</option>';
            rounds.sort().forEach(r => {
                roundFilter.innerHTML += `<option value="${r}">${r}</option>`;
            });
        }

        function setupEventListeners() {
            // 검색 버튼 이벤트 리스너
            document.getElementById('searchButton').addEventListener('click', filterAndRender);
            
            // 엔터키로 검색 가능하도록
            document.getElementById('playerSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterAndRender();
                }
            });
            
            // 초기화 버튼
            document.getElementById('resetFilters').addEventListener('click', () => {
                document.querySelectorAll('#playerSearch, #seasonFilter, #roundFilter, #sortFilter').forEach(el => el.value = '');
                document.getElementById('playersTableBody').innerHTML = '<tr><td colspan="11" style="text-align: center;">검색 조건을 설정하고 검색하기 버튼을 눌러주세요.</td></tr>';
                document.getElementById('filteredPlayers').textContent = '0';
            });
            
            // 모달 닫기 버튼 이벤트 리스너
            document.querySelector('.close').addEventListener('click', function() {
                document.getElementById('playerModal').style.display = 'none';
            });
            
            // 모달 외부 클릭시 닫기
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('playerModal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        function filterAndRender() {
            const searchTerm = document.getElementById('playerSearch').value.toLowerCase();
            const season = document.getElementById('seasonFilter').value;
            const round = document.getElementById('roundFilter').value;
            const sortBy = document.getElementById('sortFilter').value;

            // 성별 필터링
            let filteredTournaments = tournaments.filter(t => t.gender === currentGender);
            
            // 시즌/라운드 필터링
            if (season) {
                filteredTournaments = filteredTournaments.filter(t => t.season == season);
            }
            if (round) {
                filteredTournaments = filteredTournaments.filter(t => t.round === round);
            }

            // 해당 토너먼트의 매치 ID들
            const relevantMatchIds = new Set(
                matches.filter(m => filteredTournaments.some(t => t.id === m.tournaments_id))
                       .map(m => m.id)
            );

            // 선수 데이터 필터링 - 필터가 없으면 모든 데이터 표시
            if (!season && !round && !searchTerm) {
                filteredData = processedPlayersData.filter(player => player.games > 0);
            } else {
                filteredData = processedPlayersData.filter(player => {
                    const hasStatsInFilter = player_match_stats.some(s => 
                        s.player_id === player.id && relevantMatchIds.has(s.match_id)
                    );
                    const matchesSearch = player.name.toLowerCase().includes(searchTerm);
                    return hasStatsInFilter && player.games > 0 && matchesSearch;
                });
            }

            // 정렬 기준 설정
            const sortMap = {
                'points': 9,
                'attack': 6,
                'blocks': 7,
                'serves': 8,
                'games': 4
            };
            currentSort.column = sortMap[sortBy] || 9;
            currentSort.direction = 'desc';

            currentPage = 1;
            sortAndRender();
        }

        function sortTable(columnIndex) {
            if (currentSort.column === columnIndex) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = columnIndex;
                currentSort.direction = 'asc';
            }
            sortAndRender();
        }

        function sortAndRender() {
            const { column, direction } = currentSort;
            
            filteredData.sort((a, b) => {
                let valA, valB;
                
                switch(column) {
                    case 1: // 선수명
                        valA = a.name.toLowerCase();
                        valB = b.name.toLowerCase();
                        break;
                    case 2: // 포지션
                        valA = a.position;
                        valB = b.position;
                        break;
                    case 3: // 팀명
                        valA = a.team.name.toLowerCase();
                        valB = b.team.name.toLowerCase();
                        break;
                    case 4: // 경기수
                        valA = a.games;
                        valB = b.games;
                        break;
                    case 5: // 세트수
                        valA = a.sets;
                        valB = b.sets;
                        break;
                    case 6: // 공격
                        valA = a.attack;
                        valB = b.attack;
                        break;
                    case 7: // 블로킹
                        valA = a.blocks;
                        valB = b.blocks;
                        break;
                    case 8: // 서브
                        valA = a.serves;
                        valB = b.serves;
                        break;
                    case 9: // 득점
                        valA = a.points;
                        valB = b.points;
                        break;
                    default:
                        valA = a.points;
                        valB = b.points;
                }

                if (typeof valA === 'string') {
                    return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    return direction === 'asc' ? valA - valB : valB - valA;
                }
            });

            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('playersTableBody');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            document.getElementById('filteredPlayers').textContent = filteredData.length.toLocaleString();
            document.getElementById('totalPlayers').textContent = players.length.toLocaleString();

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center;">데이터가 없습니다.</td></tr>';
            } else {
                tbody.innerHTML = pageData.map((player, index) => {
                    const positionClass = getPositionClass(player.position);
                    return `
                        <tr>
                            <td class="rank">${start + index + 1}</td>
                            <td class="player-name">${player.name}</td>
                            <td class="hide-on-mobile"><span class="position ${positionClass}">${getPositionText(player.position)}</span></td>
                            <td class="hide-on-mobile">${player.team.name}</td>
                            <td class="hide-on-mobile">${player.games}</td>
                            <td class="hide-on-mobile">${player.sets}</td>
                            <td class="hide-on-mobile">${player.attack}</td>
                            <td class="hide-on-mobile">${player.blocks}</td>
                            <td class="hide-on-mobile">${player.serves}</td>
                            <td class="hide-on-mobile"><strong>${player.points}</strong></td>
                            <td><button class="view-btn" onclick='showPlayerDetail(${player.id})'>상세</button></td>
                        </tr>
                    `;
                }).join('');
            }
            renderPagination();
        }

        function changePage(offset) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const newPage = currentPage + offset;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        function renderPagination() {
            const pageNumbers = document.getElementById('pageNumbers');
            if (!pageNumbers) return;
            
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            pageNumbers.innerHTML = '';

            const prevButton = document.querySelector('.pagination .page-btn:first-child');
            const nextButton = document.querySelector('.pagination .page-btn:last-child');
            if(prevButton) prevButton.disabled = currentPage === 1;
            if(nextButton) nextButton.disabled = currentPage === totalPages || totalPages === 0;

            for (let i = 1; i <= totalPages; i++) {
                if (totalPages > 1) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => {
                        currentPage = i;
                        renderTable();
                    };
                    pageNumbers.appendChild(pageBtn);
                }
            }
        }

        function showPlayerDetail(playerId) {
            const player = processedPlayersData.find(p => p.id === playerId);
            const playerStats = player_match_stats.filter(s => s.player_id === playerId);

            document.getElementById('modalPlayerName').textContent = player.name;
            document.getElementById('modalPlayerSchool').textContent = player.team.name;
            document.getElementById('modalPlayerPosition').textContent = getPositionName(player.position);
            
            const statsGrid = document.getElementById('modalStatsGrid');
            statsGrid.innerHTML = ''; // Clear previous stats

            const aggregatedStats = playerStats.reduce((acc, stat) => {
                acc.points += stat.points;
                acc.games = (acc.games || new Set()).add(stat.match_id);
                Object.keys(stat).forEach(key => {
                    if (key.includes('_')) { // is a stat like attack_attempts
                        acc[key] = (acc[key] || 0) + stat[key];
                    }
                });
                return acc;
            }, { points: 0 });

            const statCategories = {
                '득점': aggregatedStats.points,
                '경기 수': aggregatedStats.games.size,
                '공격 성공률': `${(aggregatedStats.attack_attempts > 0 ? (aggregatedStats.attack_successes / aggregatedStats.attack_attempts * 100) : 0).toFixed(1)}%`,
                '블로킹': aggregatedStats.block_successes,
                '서브': aggregatedStats.serve_aces,
                '리시브 성공률': `${(aggregatedStats.receive_attempts > 0 ? (aggregatedStats.receive_successes / aggregatedStats.receive_attempts * 100) : 0).toFixed(1)}%`
            };

            for(const [title, value] of Object.entries(statCategories)) {
                statsGrid.innerHTML += `
                    <div class="stat-item">
                        <div class="stat-title">${title}</div>
                        <div class="stat-value">${value}</div>
                    </div>
                `;
            }

            const recentGamesContainer = document.getElementById('recentGames');
            recentGamesContainer.innerHTML = playerStats.map(stat => {
                const match = matches.find(m => m.id === stat.match_id);
                const opponent = teams.find(t => t.id === (match.home_team_id === player.team_id ? match.away_team_id : match.home_team_id));
                return `<div class="game-item">vs. ${opponent.name} - 득점: ${stat.points}, 블록: ${stat.block_successes}, 서브에이스: ${stat.serve_aces}</div>`;
            }).join('') || '<p>경기 기록이 없습니다.</p>';

            document.getElementById('playerModal').style.display = 'block';
        }

        function getPositionClass(position) {
            return position;
        }

        function getPositionText(position) {
            const positions = { 
                setter: "세터", 
                outside: "아웃사이드 히터", 
                middle: "미들 블로커", 
                opposite: "오포지트", 
                libero: "리베로" 
            };
            return positions[position] || position;
        }

        function getPositionName(position) {
            const positions = { setter: "세터", outside: "아웃사이드 히터", middle: "미들 블로커", opposite: "오포지트", libero: "리베로" };
            return positions[position] || position;
        }

        function exportData() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "이름,팀,포지션,경기수,세트수,공격,블로킹,서브,득점\n";
            filteredData.forEach(p => {
                csvContent += `${p.name},${p.team.name},${getPositionText(p.position)},${p.games},${p.sets},${p.attack},${p.blocks},${p.serves},${p.points}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "player_records.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>