<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>선수 개인 기록 - 중고등 배구 데이터</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-volleyball-ball"></i>
                <span>배구 연맹 데이터</span>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link">홈</a>
                <a href="team_ranking.html" class="nav-link">팀 순위</a>
                <a href="player_record.html" class="nav-link active">선수 기록</a>
                <a href="player_certification.html" class="nav-link hide-on-mobile" target="_blank">기록 증명서</a>
                <a href="admin.html" class="nav-link admin-only-nav" style="display:none;">관리자</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- 페이지 헤더 -->
        <div class="page-header">
            <h1><i class="fas fa-user-friends"></i> 선수 개인 기록</h1>
            <p>전국 중고등학교 배구 선수들의 상세 기록을 확인하세요</p>
        </div>

        <!-- 검색 및 필터 -->
        <div class="search-section">
            <div class="search-controls">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="playerSearch" placeholder="선수 이름으로 검색">
                </div>
                <div class="filter-group">                    
                    <select id="seasonFilter">
                        <option value="">시즌 선택</option>
                        <!-- 동적으로 생성 -->
                    </select>
                    <select id="roundFilter">
                        <option value="">라운드 선택</option>
                        <!-- 동적으로 생성 -->
                    </select>
                    <select id="genderFilter">
                        <option value="">성별 선택</option>
                        <!-- 동적으로 생성 -->
                    </select>
                    <select id="schoolFilter">
                        <option value="">모든 학교</option>
                        <option value="high">고등학교</option>
                        <option value="middle">중학교</option>
                    </select>
                    <select id="positionFilter">
                        <option value="">모든 포지션</option>
                        <option value="setter">세터</option>
                        <option value="outside">아웃사이드 히터</option>
                        <option value="middle">미들 블로커</option>
                        <option value="opposite">오포지트</option>
                        <option value="libero">리베로</option>
                    </select>
                    <button class="btn btn-outline" onclick="resetFilters()">
                        <i class="fas fa-undo"></i> 초기화
                    </button>
                </div>
            </div>
        </div>

        <!-- 통계 요약 -->
        <div class="stats-summary hide-on-mobile">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-number" id="totalPlayers">0</div>
                    <div class="stat-label">총 선수 수</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-number" id="filteredPlayers">0</div>
                    <div class="stat-label">검색 결과</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-number">156</div>
                    <div class="stat-label">MVP 선수</div>
                </div>
            </div>
        </div>

        <!-- 선수 기록 테이블 -->
        <div class="table-container">
            <div class="table-header">
                <h2>선수 기록</h2>
                <div class="table-actions hide-on-mobile">
                    <button class="btn btn-outline" onclick="exportData()">
                        <i class="fas fa-download"></i> 엑셀 다운로드
                    </button>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table class="players-table" id="playersTable">
                    <thead>
                        <tr>
                            <th>순위</th>
                            <th onclick="sortTable(1)">
                                이름 <i class="fas fa-sort"></i>
                            </th>
                            <th class="hide-on-mobile" onclick="sortTable(2)">
                                학교 <i class="fas fa-sort"></i>
                            </th>
                            <th class="hide-on-mobile" onclick="sortTable(3)">
                                포지션 <i class="fas fa-sort"></i>
                            </th>
                            <th class="hide-on-mobile" onclick="sortTable(4)">
                                경기 수 <i class="fas fa-sort"></i>
                            </th>
                            <th class="hide-on-mobile" onclick="sortTable(5)">
                                득점 <i class="fas fa-sort"></i>
                            </th>
                            <th class="hide-on-mobile" onclick="sortTable(6)">
                                어택 성공률 <i class="fas fa-sort"></i>
                            </th>
                            <th class="hide-on-mobile" onclick="sortTable(7)">
                                블록 <i class="fas fa-sort"></i>
                            </th>
                            <th class="hide-on-mobile" onclick="sortTable(8)">
                                서브 에이스 <i class="fas fa-sort"></i>
                            </th>
                            <th>상세</th>
                        </tr>
                    </thead>
                    <tbody id="playersTableBody">
                        <!-- 데이터는 JavaScript로 동적 생성 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination">
            <button class="page-btn" onclick="changePage(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="page-numbers" id="pageNumbers">
                <!-- 페이지 번호는 JavaScript로 동적 생성 -->
            </div>
            <button class="page-btn" onclick="changePage(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- 선수 상세 모달 -->
    <div id="playerModal" class="modal">
        <div class="modal-content large">
            <span class="close">&times;</span>
            <div class="player-detail">
                <div class="player-header">
                    <div class="player-photo">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="player-info">
                        <h2 id="modalPlayerName"></h2>
                        <p id="modalPlayerSchool"></p>
                        <p id="modalPlayerPosition"></p>
                    </div>
                </div>
                
                <div class="player-stats">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-title">총 경기 수</div>
                            <div class="stat-value" id="modalGames"></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-title">총 득점</div>
                            <div class="stat-value" id="modalPoints"></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-title">어택 성공률</div>
                            <div class="stat-value" id="modalAttackRate"></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-title">블록 포인트</div>
                            <div class="stat-value" id="modalBlocks"></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-title">서브 에이스</div>
                            <div class="stat-value" id="modalAces"></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-title">리시브 성공률</div>
                            <div class="stat-value" id="modalReceiveRate"></div>
                        </div>
                    </div>
                </div>

                <div class="recent-games">
                    <h3>최근 경기 기록</h3>
                    <div class="games-list" id="recentGames">
                        <!-- 최근 경기 기록 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        /* 헤더 */
        .header {
            background-color: #667eea;
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .logo i {
            font-size: 2rem;
            color: #ffd700;
        }

        .nav {
            display: flex;
            gap: 2rem;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }

        .nav-link:hover, .nav-link.active {
            color: #ffd700;
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* 컨테이너 */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* 페이지 헤더 */
        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .page-header h1 i {
            color: #667eea;
            margin-right: 0.5rem;
        }

        .page-header p {
            font-size: 1.1rem;
            color: #666;
        }

        /* 검색 섹션 */
        .search-section {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .search-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .search-box input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 3rem;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .filter-group select {
            padding: 0.8rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        /* 통계 요약 */
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon i {
            font-size: 1.5rem;
            color: white;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* 테이블 컨테이너 */
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .table-header h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .players-table {
            width: 100%;
            border-collapse: collapse;
        }

        .players-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: background-color 0.3s;
        }

        .players-table th:hover {
            background: #e9ecef;
        }

        .players-table th i {
            margin-left: 0.5rem;
            color: #999;
        }

        .players-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }

        .players-table tr:hover {
            background: #f8f9fa;
        }

        .rank {
            font-weight: bold;
            color: #667eea;
        }

        .player-name {
            font-weight: 600;
            color: #333;
        }

        .position {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .position.setter { background: #e3f2fd; color: #1976d2; }
        .position.outside { background: #f3e5f5; color: #7b1fa2; }
        .position.middle { background: #e8f5e8; color: #388e3c; }
        .position.opposite { background: #fff3e0; color: #f57c00; }
        .position.libero { background: #ffebee; color: #d32f2f; }

        .view-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.3s;
        }

        .view-btn:hover {
            background: #5a67d8;
        }

        .view-btn .short-text {
            display: none;
        }

        /* 페이지네이션 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .page-btn {
            background: white;
            border: 2px solid #e9ecef;
            color: #667eea;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-numbers {
            display: flex;
            gap: 0.25rem;
        }

        .page-number {
            padding: 0.5rem 0.8rem;
            border: 2px solid #e9ecef;
            background: white;
            color: #667eea;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .page-number.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-number:hover:not(.active) {
            background: #f8f9fa;
        }

        /* 버튼 스타일 */
        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-block;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-outline {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        /* 모달 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 1rem;
        }

        .close:hover {
            color: black;
        }

        .player-detail {
            padding: 2rem;
        }

        .player-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #e9ecef;
        }

        .player-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-photo i {
            font-size: 4rem;
            color: white;
        }

        .player-info h2 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .player-info p {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            text-align: center;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-title {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .recent-games h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .games-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .game-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* 반응형 디자인 */
        @media screen and (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .nav {
                gap: 1rem;
            }
            
            .hide-on-mobile {
                display: none;
            }

            .search-box {
                min-width: auto;
            }

            .filter-group {
                align-items: stretch;
                flex-direction: column;
                gap: 0.5rem;
            }

            .filter-group select {
                width: 100%;
                min-width: auto;
            }
            
            .search-controls {
                align-items: stretch;
                flex-direction: column;
            }

            .table-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .player-header {
                flex-direction: column;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .players-table .rank {
                width: 30px;
            }

            .view-btn .long-text {
                display: none;
            }

            .view-btn .short-text {
                display: inline;
            }
        }

        @media screen and (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .footer {
            background-color: #343a40;
            color: white;
            text-align: center;
            padding: 2rem 1rem;
            margin-top: 3rem;
        }

        .footer-content p {
            margin: 0.5rem 0;
        }
    </style>

    <script src="data.js"></script>
    <script>
        let processedPlayersData = [];
        let filteredData = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentSort = { column: 0, direction: 'asc' };

        document.addEventListener('DOMContentLoaded', function() {
            processPlayerData();
            populateSeasonFilter();
            updateDependentFilters(); // 초기 필터 채우기
            filterPlayers(); // 초기 렌더링
            setupEventListeners();
        });

        function processPlayerData() {
            const playerStatsMap = new Map();

            players.forEach(player => {
                const team = teams.find(t => t.id === player.team_id);
                playerStatsMap.set(player.id, {
                    ...player,
                    school: team ? team.name : '알 수 없음',
                    schoolType: team ? team.school_level : '알 수 없음',
                    games: 0,
                    totalPoints: 0,
                    totalAttackAttempts: 0,
                    totalAttackSuccesses: 0,
                    totalBlocks: 0,
                    totalAces: 0,
                    recentGames: [],
                    tournaments: new Set(),
                    seasons: new Set(),
                    rounds: new Set(),
                    genders: new Set()
                });
            });

            stats.forEach(stat => {
                const player = playerStatsMap.get(stat.player_id);
                if (player) {
                    const match = matches.find(m => m.id === stat.match_id);
                    if (match) {
                        const tournament = tournaments.find(t => t.id === match.tournament_id);
                        if (tournament) {
                            player.tournaments.add(tournament.id);
                            player.seasons.add(tournament.season);
                            player.rounds.add(tournament.round);
                            player.genders.add(tournament.gender);
                            
                            player.games++;
                            player.totalPoints += stat.points;
                            player.totalBlocks += stat.blocks;
                            player.totalAces += stat.aces;
                            player.totalAttackSuccesses += stat.attack_rate; // This is a simplification
                            player.totalAttackAttempts++; 

                            player.recentGames.push({
                                match_id: stat.match_id,
                                points: stat.points,
                                blocks: stat.blocks,
                                aces: stat.aces
                            });
                        }
                    }
                }
            });

            processedPlayersData = Array.from(playerStatsMap.values()).map(player => ({
                ...player,
                points: player.totalPoints,
                attackRate: player.totalAttackAttempts > 0 ? (player.totalAttackSuccesses / player.totalAttackAttempts).toFixed(1) : 0,
                blocks: player.totalBlocks,
                aces: player.totalAces,
                receiveRate: 0, // Placeholder
                seasons: Array.from(player.seasons),
                rounds: Array.from(player.rounds),
                genders: Array.from(player.genders)
            }));
        }

        function populateSeasonFilter() {
            const seasons = new Set(tournaments.map(t => t.season));
            const seasonFilter = document.getElementById('seasonFilter');
            Array.from(seasons).sort().forEach(season => {
                seasonFilter.add(new Option(season + '년', season));
            });
        }

        function updateDependentFilters() {
            const seasonFilter = document.getElementById('seasonFilter');
            const roundFilter = document.getElementById('roundFilter');
            const genderFilter = document.getElementById('genderFilter');
            const selectedSeason = seasonFilter.value;

            const currentRound = roundFilter.value;
            const currentGender = genderFilter.value;

            roundFilter.innerHTML = '<option value="">라운드 선택</option>';
            genderFilter.innerHTML = '<option value="">성별 선택</option>';

            if (selectedSeason) {
                roundFilter.style.display = 'inline-block';
                genderFilter.style.display = 'inline-block';

                const relevantTournaments = tournaments.filter(t => t.season == selectedSeason);
                const rounds = new Set(relevantTournaments.map(t => t.round));
                Array.from(rounds).sort().forEach(round => {
                    roundFilter.add(new Option(round, round));
                });

                const genders = new Set(relevantTournaments.map(t => t.gender));
                if (genders.has('male')) genderFilter.add(new Option('남자', 'male'));
                if (genders.has('female')) genderFilter.add(new Option('여자', 'female'));

                if (Array.from(roundFilter.options).some(opt => opt.value === currentRound)) roundFilter.value = currentRound;
                if (Array.from(genderFilter.options).some(opt => opt.value === currentGender)) genderFilter.value = currentGender;

            } else {
                roundFilter.style.display = 'none';
                genderFilter.style.display = 'none';
            }
        }

        function setupEventListeners() {
            document.getElementById('playerSearch').addEventListener('input', filterPlayers);
            document.getElementById('schoolFilter').addEventListener('change', filterPlayers);
            document.getElementById('positionFilter').addEventListener('change', filterPlayers);
            document.getElementById('seasonFilter').addEventListener('change', () => {
                updateDependentFilters();
                filterPlayers();
            });
            document.getElementById('roundFilter').addEventListener('change', filterPlayers);
            document.getElementById('genderFilter').addEventListener('change', filterPlayers);
            
            const modal = document.getElementById('playerModal');
            modal.querySelector('.close').onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target == modal) modal.style.display = 'none';
            }
        }

        function renderTable() {
            const tbody = document.getElementById('playersTableBody');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">데이터가 없습니다.</td></tr>';
            } else {
                tbody.innerHTML = pageData.map((player, index) => `
                    <tr>
                        <td class="rank">${start + index + 1}</td>
                        <td class="player-name">${player.name}</td>
                        <td class="player-school hide-on-mobile">${player.school}</td>
                        <td class="player-position hide-on-mobile"><span class="position ${player.position}">${getPositionName(player.position)}</span></td>
                        <td class="player-games hide-on-mobile">${player.games}</td>
                        <td class="player-points hide-on-mobile">${player.points}</td>
                        <td class="player-attackRate hide-on-mobile">${player.attackRate}%</td>
                        <td class="player-blocks hide-on-mobile">${player.blocks}</td>
                        <td class="player-aces hide-on-mobile">${player.aces}</td>
                        <td>
                            <button class="view-btn" onclick='showPlayerDetail(${JSON.stringify(player)})'>
                                <span class="long-text">상세보기</span>
                                <span class="short-text">보기</span>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            document.getElementById('filteredPlayers').textContent = filteredData.length.toLocaleString();
            document.getElementById('totalPlayers').textContent = processedPlayersData.length.toLocaleString();
            renderPagination();
        }

        function getPositionName(position) {
            const positions = {
                setter: "세터",
                outside: "아웃사이드 히터",
                middle: "미들 블로커",
                opposite: "오포지트",
                libero: "리베로"
            };
            return positions[position] || position;
        }

        function filterPlayers() {
            const searchTerm = document.getElementById('playerSearch').value.toLowerCase();
            const schoolFilter = document.getElementById('schoolFilter').value;
            const positionFilter = document.getElementById('positionFilter').value;
            const seasonFilter = document.getElementById('seasonFilter').value;
            const roundFilter = document.getElementById('roundFilter').value;
            const genderFilter = document.getElementById('genderFilter').value;

            filteredData = processedPlayersData.filter(player => {
                const matchesSearch = player.name.toLowerCase().includes(searchTerm);
                const matchesSchool = !schoolFilter || player.schoolType === schoolFilter;
                const matchesPosition = !positionFilter || player.position === positionFilter;
                const matchesSeason = !seasonFilter || player.seasons.includes(parseInt(seasonFilter));
                const matchesRound = !roundFilter || player.rounds.includes(roundFilter);
                const matchesGender = !genderFilter || player.genders.includes(genderFilter);
                
                return matchesSearch && matchesSchool && matchesPosition && 
                       matchesSeason && matchesRound && matchesGender;
            });

            currentPage = 1;
            sortTable(currentSort.column, true);
        }
        
        function resetFilters() {
            document.getElementById('playerSearch').value = '';
            document.getElementById('schoolFilter').value = '';
            document.getElementById('positionFilter').value = '';
            document.getElementById('seasonFilter').value = '';
            updateDependentFilters();
            filterPlayers();
        }

        function sortTable(columnIndex, keepDirection = false) {
            let direction = 'asc';
            if (!keepDirection) {
                direction = currentSort.column === columnIndex && currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                direction = currentSort.direction;
            }
            
            currentSort = { column: columnIndex, direction };
            const keys = ['rank', 'name', 'school', 'position', 'games', 'points', 'attackRate', 'blocks', 'aces'];
            const sortKey = keys[columnIndex];

            filteredData.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];

                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > b[sortKey]) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderTable();
        }

        function changePage(offset) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const newPage = currentPage + offset;

            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        function renderPagination() {
            const pageNumbers = document.getElementById('pageNumbers');
            if (!pageNumbers) return;
            
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            pageNumbers.innerHTML = '';

            document.querySelector('.pagination .page-btn:first-child').disabled = currentPage === 1;
            document.querySelector('.pagination .page-btn:last-child').disabled = currentPage === totalPages;

            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => {
                    currentPage = i;
                    renderTable();
                };
                pageNumbers.appendChild(pageBtn);
            }
        }

        function showPlayerDetail(player) {
            document.getElementById('modalPlayerName').textContent = player.name;
            document.getElementById('modalPlayerSchool').textContent = player.school;
            document.getElementById('modalPlayerPosition').textContent = getPositionName(player.position);
            document.getElementById('modalGames').textContent = player.games;
            document.getElementById('modalPoints').textContent = player.points;
            document.getElementById('modalAttackRate').textContent = player.attackRate + '%';
            document.getElementById('modalBlocks').textContent = player.blocks;
            document.getElementById('modalAces').textContent = player.aces;
            document.getElementById('modalReceiveRate').textContent = player.receiveRate + '%';

            const recentGamesContainer = document.getElementById('recentGames');
            recentGamesContainer.innerHTML = player.recentGames.map(game => {
                const match = matches.find(m => m.id === game.match_id);
                const opponentTeamId = match.home_team_id === player.team_id ? match.away_team_id : match.home_team_id;
                const opponentTeam = teams.find(t => t.id === opponentTeamId);
                return `<div class="game-item">vs. ${opponentTeam ? opponentTeam.name : '알 수 없음'} - 득점: ${game.points}, 블록: ${game.blocks}, 에이스: ${game.aces}</div>`;
            }).join('');

            document.getElementById('playerModal').style.display = 'block';
        }

        function exportData() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "이름,학교,포지션,경기 수,득점,어택 성공률,블록,서브 에이스,리시브 성공률\n";
            filteredData.forEach(p => {
                csvContent += `${p.name},${p.school},${getPositionName(p.position)},${p.games},${p.points},${p.attackRate},${p.blocks},${p.aces},${p.receiveRate}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "player_records.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>

    <footer class="footer">
        <div class="footer-content">
            <p>© 2025 Korea University Volleyball Federation (KUVF). All rights reserved.</p>
            <p>Developer Contact: kuvf.dev@gmail.com (문의)</p>
        </div>
    </footer>
</body>
</html>